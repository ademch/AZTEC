<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">


<title>BARAFOA</title>

<style>
    body {
        background-color: #EEEEEE;
    }
    canvas {
         height: 50%;
         width: 50%;
    }
	input[type='color'] {
		width: 32px;
	}
	input[type='checkbox'] {
		width: 18px;
		height: 18px;
	}
	table, th, td {
		border: 1px solid black;
	}
</style>

</head>
<body>

<h2>Parameters</h2>

 <table style="width:100%">
  <tr>
    <td style="vertical-align:top">
		
		<div>
			<input type="color" id="head" name="head" value="#e66465"/>
			&nbsp;&nbsp;
			<input type="checkbox" id="idTemperature" name="idTemperature" checked />
			<label for="idTemperature" id="idTemperatureLabel">Temperature: unknown</label>
		</div>
		<br>
		<div>
			<input type="color" id="head" name="head" value="#e66465" />
			&nbsp;&nbsp;
			<input type="checkbox" id="idPressure" name="idPressure" checked />
			<label for="idPressure" id="idPressureLabel">Pressure: unknown</label>
		</div>
		<br>
		<div>
			<input type="color" id="head" name="head" value="#e66465" />
			&nbsp;&nbsp;
			<input type="checkbox" id="idThermocouple" name="idThermocouple" checked />
			<label for="idThermocouple" id="idThermocoupleLabel">Thermocouple: unknown</label>
		</div>
		<br>
		<div>
			<input type="color" id="head" name="head" value="#e66465" />
			&nbsp;&nbsp;
			<input type="checkbox" id="idThermistor" name="idThermistor" checked />
			<label for="idThermistor" id="idThermistorLabel">Thermistor: unknown</label>
		</div>		
		<br>
		<div>
			<input type="color" id="head" name="head" value="#e66465" />
			&nbsp;&nbsp;
			<input type="checkbox" id="idSolarEnergy" name="idSolarEnergy" checked />
			<label for="idSolarEnergy" id="idSolarEnergyLabel">Solar energy: unknown</label>
		</div>		
		<br>

		
		<button type="button" class="REST" onclick="DrawPlot()" style="width: 80px">Update...</button>
		<br><br><br>
		<button type="button" class="REST" onclick="StartAutoUpdate()" style="width: 140px">Update automatically...</button>
		<button type="button" class="REST" onclick="StopAutoUpdate()"  style="width: 140px">Stop automatic update...</button>
	</td>
    <td style="width:80%">
		<canvas id="FrontCanvas" width="1620" height="820" style="border:2px solid #d3d3d3;">
			Your browser does not support the HTML5 canvas tag.
		</canvas>
	</td>
  </tr>
</table> 

<!--
 <table style="width:100%">
  <tr>
    <td width="5%">
		<div style="text-align:center;">
			<input type="checkbox" id="idTemperature" name="idTemperature" checked />
			<br>
			<br>
			<input type="color" id="head" name="head" value="#e66465"/>
			<br>
			<br>
			<small>
				Temperature:
				<br>
			<span id="idTemperatureLabel">unknown</span>
			<input type="text" id="idTemperatureMax" name="idTemperatureMax" value="300" style="width:40px; text-align:center;"/>
			°C
			</small>
		</div>
	</td>
    <td width="5%">
		<div style="text-align:center;">
			<input type="color" id="head" name="head" value="#e66465"/>
			<br>
			<input type="checkbox" id="idPressure" name="idPressure" checked />
			<label for="idPressure" id="idPressureLabel">Pressure: unknown</label>
		</div>
	</td>
    <td width="5%">
		<div style="text-align:center;">
			<input type="color" id="head" name="head" value="#e66465" />
			<br>
			<input type="checkbox" id="idThermocouple" name="idThermocouple" checked />
			<label for="idThermocouple" id="idThermocoupleLabel">Thermocouple: unknown</label>
		</div>
	</td>
    <td width="5%">
		<div style="text-align:center;">
			<input type="color" id="head" name="head" value="#e66465" />
			<br>
			<input type="checkbox" id="idThermistor" name="idThermistor" checked />
			<label for="idThermistor" id="idThermistorLabel">Thermistor: unknown</label>
		</div>		
	</td>
    <td width="5%">
		<div style="text-align:center;">
			<input type="color" id="head" name="head" value="#e66465" />
			<br>
			<input type="checkbox" id="idSolarEnergy" name="idSolarEnergy" checked />
			<label for="idSolarEnergy" id="idSolarEnergyLabel">Solar energy: unknown</label>
		</div>		
    </td>
    <td width="50%">
    </td>
  </tr>
  <tr>
    <td colspan="6">
		<canvas id="FrontCanvas" width="1620" height="820" style="border:2px solid #d3d3d3;">
			Your browser does not support the HTML5 canvas tag.
		</canvas>
	</td>
  </tr>
  <tr>
    <td>
	</td>
    <td>
	</td>
    <td>
	</td>
    <td>
	</td>
  </tr>
</table> 
-->


<script>
	var idInterval = -1;	// interval identifier
	
	var iTimeMSstart   = Date.now();
	var iMScurrent = 0;

	var aPointsTemp = [];
	var aPointsBaro = [];
	var aPointsThermocouple = [];
	var aPointsThermistor = [];
	
	var iTimeMSCompressedThreshold = 0;
	var iStepCompressed = 10;
	var iStepNormal = 10;
	var iSecondsInCompressionRange = 100;	// shortcut describing the number of seconds held by compressed part of the graph
	
	function StartAutoUpdate()
	{
		idInterval = setInterval(fetchDataAsync, 1000);
		
		iTimeMSstart = Date.now();
		iTimeMSCompressedThreshold = iTimeMSstart + 100*1000;
		iTimeMSTotalThreshold = iTimeMSstart + 160*1000;
	}
	
	function StopAutoUpdate()
	{
		if (idInterval != -1) clearInterval(idInterval);
	}
	
	async function fetchDataAsync()
	{
		try
		{
			const response = await fetch('http://localhost:8081/BARAtemperature');
			const summary  = await response.text();
			console.log(summary);
			
			const changeText = document.querySelector("#idTemperatureLabel");

			changeText.innerHTML = "Temperature: " + summary + " °C";
			
			let point = {};
			point.value = Math.random();//parseFloat(summary);
			point.time = Date.now();
			
			aPointsTemp.push(point);
		}
		catch (error)
		{
			console.log('Error:' + error.message);
		}
		try
		{
			const response = await fetch('http://localhost:8081/BARApressure');
			const summary  = await response.text();
			console.log(summary);
			
			const changeText = document.querySelector("#idPressureLabel");

			changeText.textContent = "Pressure: " + summary + " mBar";

			let point = {};
			point.value = parseFloat(summary);
			point.time = Date.now();
			
			aPointsBaro.push(point);
		}
		catch (error)
		{
			console.log('Error:' + error.message);
		}
		try
		{
			const response = await fetch('http://localhost:8081/FOAthermocouple');
			const summary  = await response.text();
			console.log(summary);
			
			const changeText = document.querySelector("#idThermocoupleLabel");

			changeText.textContent = "Thermocouple: " + summary + " v";

			let point = {};
			point.value = parseFloat(summary);
			point.time = Date.now();
			
			aPointsThermocouple.push(point);
		}
		catch (error)
		{
			console.log('Error:' + error.message);
		}
		try
		{
			const response = await fetch('http://localhost:8081/FOAthermistor');
			const summary  = await response.text();
			console.log(summary);
			
			const changeText = document.querySelector("#idThermistorLabel");

			changeText.textContent = "Thermistor: " + summary + " v";
			
			let point = {};
			point.value = parseFloat(summary);
			point.time = Date.now();
			
			aPointsThermistor.push(point);
		}
		catch (error)
		{
			console.log('Error:' + error.message);
		}
		
		DrawPlot();
	}
	
	
	function DrawPlot()
	{
		let i;

		let c = document.getElementById("FrontCanvas");
		let ctx = c.getContext("2d");

		// STEP: clear canvas
		ctx.clearRect(0, 0, c.width, c.height);

		// STEP: draw border
		ctx.strokeStyle = "black";
		ctx.lineWidth = 2;

		ctx.strokeRect(10, 10, c.width-20, c.height-100);
		
		// STEP: draw vertical dash lines
		ctx.strokeStyle = '#B0B0B0';
		ctx.setLineDash([10,10]);
		ctx.lineWidth = 1;

		for (i=1; i<=15; i++)
		{
			ctx.beginPath();
				ctx.moveTo(10+ i*100, c.height-100);
				ctx.lineTo(10+ i*100, 10);
			ctx.stroke();
		}

		// STEP: draw vertical threshold line
		ctx.strokeStyle = '#000000';
		ctx.setLineDash([]);
		ctx.lineWidth = 2;

		ctx.beginPath();
			ctx.moveTo(10+ 1000, c.height-100);
			ctx.lineTo(10+ 1000, 10);
		ctx.stroke();

		// STEP: draw time legend
		ctx.save();
			ctx.rotate(-Math.PI/2);
			ctx.textAlign = "left";
			ctx.font = "16px serif";

			ctx.fillStyle = "black";
			for (i=0; i<=10; i++)
			{
				let localTime = new Date(iTimeMSstart + (iSecondsInCompressionRange/10)*i*1000);
				ctx.fillText(localTime.toLocaleTimeString('it-IT'), -c.height+7, 10 + 7 + i*100);
			}

			ctx.fillStyle = "purple";
			for (i=1; i<=9; i++)
			{
				let localTime = new Date(iTimeMSstart + iSecondsInCompressionRange*1000 + 10*i*1000);
				ctx.fillText(localTime.toLocaleTimeString('it-IT'), -c.height+7, 10 + 7 + 1000 + i*100);
			}
		ctx.restore();
		 
		ctx.lineWidth = 2;
		ctx.beginPath();
		ctx.moveTo(10, c.height-100);
		for (i=0; i < aPointsTemp.length-1; i++)
		{
			if (aPointsTemp[i].time < iTimeMSCompressedThreshold)
			{
				let iX = (aPointsTemp[i].time - iTimeMSstart)/1000;
				ctx.lineTo(10+ iX*iStepCompressed, c.height-100-aPointsTemp[i].value*100);
			}
			else
			{
				if (aPointsTemp[i].time > iTimeMSTotalThreshold)
				{
					iTimeMSCompressedThreshold += 60*1000;
					iTimeMSTotalThreshold += 60*1000;
					iSecondsInCompressionRange += 60;
					iStepCompressed = 1000/iSecondsInCompressionRange;
					break;
				}
				else
				{
					let iX = (aPointsTemp[i].time - iTimeMSCompressedThreshold)/1000;
					ctx.lineTo(10+ 1000 + iX*iStepNormal, c.height-100-aPointsTemp[i].value*100);
				}
				
			}
		}
		ctx.strokeStyle = '#ff0000';
		ctx.stroke();

		 
		 
	}
</script>


</body></html>
